更新履歴をつらつらと。 rev96
special thanks to: UFF3の中の人

0.7.9  ----------------------------------------------------------------------------------

- フィールドのウインドウ描画ルーチンを若干最適化(暫定的な実装)
 (field::drawWindowContent=$3f:f6aa)

- 宝箱に関連するルーチンを最適化・再配置
 ギル取得時(宝箱/所持品売却)に所持ギルが0x980000を越えると
 0x98967f(9999999)になるオリジナルのバグを修正(実質無害)

0.7.8  ----------------------------------------------------------------------------------

- >敵の行動選択時に、常に1グループ目の敵IDを使用していたバグを修正
 ↑間違い。バリアチェンジ判定のみ影響（実質無害)

- 「ふみこむ」「ジャンプ」「ためる」による攻撃の場合、ダメージ上限を解除し
 表示上は9999までだが内部的には65535まで当たるように変更
 現実装では魔法にも影響する(が、空手家は魔法が使えない)

- 敵の行動決定ルーチンを少々最適化

0.7.7  ----------------------------------------------------------------------------------

-「ちょうはつ」のバランス調整
 基本成功率を100%に増加、盾装備時のペナルティを緩和(-20%)

- 敵の行動選択時に、常に1グループ目の敵IDを使用していたバグを修正

- 敵打撃時、味方側に有効なターゲットがいない場合にハングしていたバグを修正
 ジャンプしているキャラがいるときのみこの状況が発生
 30:9EB9  4c 64 a2 => 4C B5 A2

0.7.6  ----------------------------------------------------------------------------------

- 特殊攻撃0x58-71の効果音をいじるとハングするバグを修正(>>729-)
  原因はコードをそこに配置していたため

- 「みだれうち」したときに相手が分裂すると1回で止まるバグを修正
   ダメージ保存領域を$7900=>$7450に変更

- 「あんこく」の属性倍率を弱点優先に変更(耐性と弱点両方あった場合弱点とみなす)

- 自分に「ふみこむ」した場合の動作を変更

- ウインドウ描画コードを更に最適化

0.7.5  ----------------------------------------------------------------------------------

- 「ふみこむ」で自分を攻撃すると大ダメージが入る現象を緩和(>>620)
  溜めている自分に攻撃して更に自分に反撃していたせい

- 「ふみこむ」したときに敵が分裂した場合以後
  行動ごとに分裂処理が発生してるように見える(実際には蘇生処理)バグを修正(>>620)
  原因は分裂した敵グループIDを保存してなかったため

- 逃走不可能な戦闘の場合「にげる」「とんずら」を選択できないように変更

- 文字列デコード処理を最適化
  ウインドウ描画用タイル保存領域の配置を最適化、描画速度10%程度Up(体感不能)

0.7.4  ----------------------------------------------------------------------------------

- 「ふみこむ」をとどめのときは反撃を食らわないように修正

- オリジナルの石化メッセージが出たり出なかったりするバグを修正

- カウンターするまえにキャッシュをきちんと入れ替えるように変更

- ステータスとキャッシュの同期がとれてないときに乱れ撃ちすると
  無限ループに陥る潜在的なバグを修正
  通常は同期が取れてたので問題なし

- 「みだれうち」したときに追加効果が正しく反映されないのを修正
  ステータスを更新してなかった

- 戦闘用ウインドウ描画コードを更に最適化
  アイテムウインドウ 2フレーム/列 → 1
  魔法ウインドウ 3フレーム → 2
  限界に近い
  IRQが重い(音の処理が多い)と描画が乱れる可能性あり => vblank中はirq切ってるから大丈夫

- 魔法ウインドウを閉じるとき稀にキャラが欠けることがあるバグを修正
  原因はカーソル番号指定忘れ

- 格闘能力(素手の攻撃力がLVで増加)をジョブ判定からパッシブ扱いに変更

0.7.3  ----------------------------------------------------------------------------------

- 「ふみこむ」を実装
  そのために各種コマンドのコードを少し整形・汎用化

- ジャンプのターゲットが指定と違うバグを修正
  原因は設定し忘れ
  ターゲットが着地前に死ぬとまだ変なとこにターゲット番号が出るが当面仕様

- 打撃計算処理をほぼ全面的に書き換え
  「ためる」が両手にかかるように変更
  ダメージではなく攻撃力を増加する形に変更

0.7.2  ----------------------------------------------------------------------------------

- アイテムウインドウを開くと落ちることがあるバグに対処(>>531)
  それに伴いオリジナルの階層移動バグにも対処
  原因は未使用だと思ってウインドウ描画コードを生成していたスタック領域が
  実はダンジョンで階層を移動するたびに消費されていた(デジョン用?)ため
  生成コードが暴走したり呼び出し時に描画コードを破壊したりしていた
  割り込みがかかると更にスタックへの負荷が高まるためそのタイミングで落ちやすかったようだ
  コードの展開先をエフェクトデータ用領域($7900)に変更
  階層移動を禁止する閾値をS=$20から S=$4bに変更

- オリジナルのダメージ255倍バグを修正

- ウインドウ領域消去処理を最適化
  1フレーム毎に下から1行ずつ消していたのを1フレームで全消去(裏画面もあるので計2フレーム)
  きびきび動くがちらついてる感じも受ける

- 「あんこく」の威力を調整
   対象がちょうどHP0になると死なないバグを修正

0.7.1  ----------------------------------------------------------------------------------

-  「おうえん」を強化
   効果を右手攻撃力+10 → 追加攻撃力+32に変更

-  「おどかす」を強化
   効果を敵Lv-3 → 敵Lv 3/4に変更

-  海中で「ちけい」をするとハングするバグを修正
   最適化の過程でうずしおの行動番号を間違えた

-  「ちけい」をやや強化
   魔法計算時Lvに熟練度を加算
   威力があっても使いにくい(使えなくはない)ことにはかわりがないようだ

0.7.0  ----------------------------------------------------------------------------------

-  「しらべる」とエミュによってはハングするバグを修正(>>506)
   原因はジャンプテーブルのアドレスが$99ffだったため
   CPUの間接ジャンプ命令バグにひっかかった
   エミュによってCPUの細かな実装が違うため動作するものとしないものがあったと思われる
   資料によってはFC用のCPUはこのバグを修正してあると書いてあるものもあるが
   ハングするほうがおそらく正しい


-  「みやぶる」の表示が間違ってるバグを修正
   弱点があったときにメッセージ番号をそのまま弱点扱いしていた

-  乱れ撃ちのダメージ表示の細かいバグを修正
   これでほぼ完璧

-  逆吸収時の仕様を変更した
   耐え切るHPがあってもダメージが入るし
   相手も回復するようになった

-  暗黒を実装した
   モーションとエフェクトがいまいち気に入らない

-  挑発のモーションを改善した
   余計な詠唱が無くなった

0.6.3  ----------------------------------------------------------------------------------

-  挑発された時のクリティカル率を75%に下げた

-  カウンター時のクリティカル率を50%に下げた

-  死人がカウンターするバグを修正
   原因は対象のステータス未チェック

-  乱れ撃ちのダメージ表示をまじめに実装した
   吸収・ミス・ダメージが同一の相手に混在しても大丈夫
   9999以上与えてから回復した場合数字がおかしいが今のところ仕様
   逆吸収で死んだときも数字がおかしいがおそらく打撃計算処理の仕様

-  各コマンドの処理を最適化Lv2
   コマンドの実装を素直な形に変更した
   それに伴い大幅にコードの配置を変更
   0x16=ちょうはつ 0x17=みだれうち 0x18=あんこく

-  カウンターをすると敵に状態異常コピーしてしまうバグ(>>501)を修正
   原因は攻撃側と防御側の状態異常キャッシュの入れ替えをやっていなかった

- 「ちけい」のターゲットが不正なバグを修正

0.6.2  ----------------------------------------------------------------------------------

- インビンシブルの援護があるともはや戦闘続行不可能なバグ(>>497)を修正
  原因は戦闘表示処理チェインにアドレス直打ちしていた関数があった
  ( ﾟдﾟ)...

- 各コマンドの処理を全て最適化lv1

- コマンド入力時にときたまキャラが欠けるバグを修正
  原因はカーソルを消す関数にindexを渡し忘れ

- 乱れ撃ちのダメージ表示がおかしい(>>495)バグを修正
  原因はオリジナルの打撃計算処理がミス時は攻撃側ダメージを更新しない+
  未実装のbit命令をダメージ加算処理で使用していた
  まだ直ってない可能性あり
  同一の相手に吸収とダメージが混在してる場合数字がおかしくなるがそれは次の版で対応

0.6.1  ----------------------------------------------------------------------------------

- ボスが不死鳥能力を獲得しているバグを修正(>>486,487)
  原因は消耗品使用時、データサイズの指定し忘れによる
  フィールド用変数保存領域の破壊

- 乱れ撃ちのモーションを変更
  攻撃ごとに移動していたのをやめた
  弓以外だとちょっと味気ないきもする

0.6.0  ----------------------------------------------------------------------------------

- 乱れ撃ちの実装が汚すぎたので違う形でやりなおした
  吸収の表示も対応

- 召還能力をオリジナルのジョブ判定からパッシブ能力扱いに変更した
  フラグありで合体

- 内部的に色々最適化:
  コマンド初期化処理、エフェクトdispatcher、表示処理チェイン、魔法ウインドウ
  召還前処理、HPウインドウ、ちょうはつ

0.5.6  ----------------------------------------------------------------------------------

- 乱れ撃ちを実装・狩人に持たせる
  吸収属性を持った武器で攻撃した場合、
  攻撃側(吸収分、アンデットならダメージ)の数字がおかしいが
  当面仕様とする(内部的にはきちんと回復/ダメージが入っている)

- 魔法選択ウインドウにおいて縦方向と横方向を同時に入力すると
  カーソルと選択される魔法が異なるバグを修正(>>460)
  原因はカーソル移動処理(オリジナルのもの)と選択移動処理の入力受付優先順位が逆
  コマンドウインドウでも起き得ると思われるが横が一列しかないため顕在化せず

- 矢(or弓)を片手に持ち他方が素手のとき
  矢のパラメータが読み込まれてしまうバグを修正(>>459)
  メデューサの矢ﾃﾗﾂﾖｽになっていた
  原因は素手扱いする手が逆だった

0.5.5  ----------------------------------------------------------------------------------

- 魔法がついてない武器を使用した場合ハングしゲーム続行不可能になるバグを修正
  原因は効果判定をそもそも間違えていた

- 追加コマンド用に内部実装を色々変更

- パッシブ能力(カウンター・アイテム効果2倍・かばう)を
  各ルーチンにハードコードしていたのを
  拡張用フラグ($31:aab0からの22バイト)を見るように内部実装を変更
  フラグを立てることで任意のジョブに能力を持たせることが可能になった

- 打撃ヒットエフェクトのフレーム数が奇数の2倍だった場合
  一部のエフェクトで位置がおかしい(その前に殴った敵の上になる)バグを修正
  原因はオリジナルのルーチンが偶数フレームでしか位置を更新しないため

0.5.4  ----------------------------------------------------------------------------------

- 武器についている魔法が無効化していたバグを修正(>>427)
  原因は効果判定が逆条件

- ヒット回数に応じて打撃モーションの速度を変えるようにした
  各武器に設定されている振る回数の上限を一部緩和(竪琴・弓・矢・ブーメラン・円月輪 以外)

- カウンターを実装・とりあえずモンクに持たせてみる
  「構える」の方が戦略的かもしれない

0.5.3  ----------------------------------------------------------------------------------

- 学者の特性にアイテム効果2倍を実装

- item99封印版をつけるようにした

0.5.2  ----------------------------------------------------------------------------------

- 合体リバイアのメッセージ("つなみをおこした!")が不正なバグを修正(>>375)
  他にバハムル・カタストも上書きしていた
  原因は文字列ポインタテーブルの設定ミス

- 全員ジャンプしているとクムクムにバックアタックされるかハングするバグを修正(>>373)
  原因は敵ターゲット決定処理のスタック不整合

- ちょうはつ成功判定に不正なポインタを使用していたバグを修正
  盾判定を攻撃回数ではなくフラグを見るように修正

0.5.1  ----------------------------------------------------------------------------------

- パラメータ計算処理の武器種別判定処理を書き換え

- 打撃計算処理の前半部分を最適化

- HP増加量が不正なバグを修正(>>366)
  熟練度が41以上で確実に発生(40の場合は最大HP次第)、発生すると必ずHPが3840〜4095になる
  原因はオフセット戻し忘れ

- コマンド入力時、左を軽く押しながら決定すると2番目、
  右を軽く押しながら決定すると1番目が
  カーソル位置にかかわらず選択されるバグを修正(>>366)
  原因は最適化ミス

- HP回復アイテムのメッセージ("HPかいふく!")が空になっていたのを修正(>>362)
  原因は挑発用メッセージの終端が丁度上書き

0.5.0  ----------------------------------------------------------------------------------

- 属性ボーナスが適用されるよう変更

- Lvアップ時のHP増加量を9bit精度に変更(16bitだが上位7bitは常に0)

- 敵の行動決定ルーチンを最適化・時限付きステータスを解除する仕組みを組み込み

- オープニングで文字が崩れるバグを修正(>>313)
  原因は改行とタブの実装省略

- セーブできないバグを修正(>>317)
  原因はiNESヘッダのマッパー情報

0.4.1 ----------------------------------------------------------------------------------

- アイテムウインドウを開閉すると空のアイテムの個数が増えるバグを修正(>>307)
  原因はコマンドウインドウ処理のアイテム使用キャンセル判定が逆条件

0.4.0 ----------------------------------------------------------------------------------

- スレ投下した最初のバージョン
